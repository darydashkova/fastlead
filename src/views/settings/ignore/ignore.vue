<template>
<div class="settings-ignore">
    <div class="settings-ignore__header">
        <div class="settings-ignore__header-nav">
            <svg  width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_923:23867)">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M15.4444 4.00033H3.22222C3.07488 4.00033 2.93357 3.93009 2.82939 3.80506C2.7252 3.68004 2.66667 3.51047 2.66667 3.33366C2.66667 3.15685 2.7252 2.98728 2.82939 2.86225C2.93357 2.73723 3.07488 2.66699 3.22222 2.66699H15.4444C15.5918 2.66699 15.7331 2.73723 15.8373 2.86225C15.9415 2.98728 16 3.15685 16 3.33366C16 3.51047 15.9415 3.68004 15.8373 3.80506C15.7331 3.93009 15.5918 4.00033 15.4444 4.00033ZM6 7.11144H15.3333C15.5101 7.11144 15.6797 7.18168 15.8047 7.3067C15.9298 7.43172 16 7.60129 16 7.7781C16 7.95491 15.9298 8.12449 15.8047 8.24951C15.6797 8.37453 15.5101 8.44477 15.3333 8.44477H6C5.82319 8.44477 5.65362 8.37453 5.5286 8.24951C5.40357 8.12449 5.33333 7.95491 5.33333 7.7781C5.33333 7.60129 5.40357 7.43172 5.5286 7.3067C5.65362 7.18168 5.82319 7.11144 6 7.11144ZM15.4444 12.0003H3.22222C3.07488 12.0003 2.93357 12.0705 2.82939 12.1956C2.7252 12.3206 2.66667 12.4902 2.66667 12.667C2.66667 12.8438 2.7252 13.0134 2.82939 13.1384C2.93357 13.2634 3.07488 13.3337 3.22222 13.3337H15.4444C15.5918 13.3337 15.7331 13.2634 15.8373 13.1384C15.9415 13.0134 16 12.8438 16 12.667C16 12.4902 15.9415 12.3206 15.8373 12.1956C15.7331 12.0705 15.5918 12.0003 15.4444 12.0003ZM3.32892 8.50951L1.21394 10.4736C1.11445 10.566 0.987674 10.6289 0.849681 10.6543C0.711683 10.6798 0.568658 10.6667 0.438701 10.6166C0.308744 10.5665 0.197695 10.4818 0.119603 10.3731C0.041513 10.2644 -0.000110252 10.1367 2.19329e-07 10.0061V5.99461C-0.000110252 5.86395 0.041513 5.7362 0.119603 5.62751C0.197695 5.51883 0.308744 5.43411 0.438701 5.38405C0.568658 5.33399 0.711683 5.32086 0.849681 5.34631C0.987674 5.37176 1.11445 5.43465 1.21394 5.52702L3.32892 7.49113C3.47406 7.62632 3.55556 7.80942 3.55556 8.00032C3.55556 8.19122 3.47406 8.37433 3.32892 8.50951Z" fill="#9797BB"/>
                </g>
                <defs>
                <clipPath id="clip0_923:23867">
                <rect width="16" height="16" fill="white"/>
                </clipPath>
                </defs>
            </svg>
            <div  class="settings-ignore__header-nav-title">
                Игнор лист
            </div>
        </div>
        <div class="pointer">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M16.365 11.3737C15.9944 11.3061 15.6134 11.3209 15.249 11.4169C14.8847 11.5129 14.5459 11.6878 14.2566 11.9292C13.9674 12.1707 13.7347 12.4727 13.5751 12.814C13.4155 13.1553 13.3328 13.5276 13.333 13.9043C13.333 14.0748 13.4007 14.2383 13.5213 14.3589C13.6418 14.4794 13.8053 14.5471 13.9758 14.5471C14.1463 14.5471 14.3098 14.4794 14.4303 14.3589C14.5509 14.2383 14.6186 14.0748 14.6186 13.9043C14.6184 13.7152 14.66 13.5284 14.7403 13.3572C14.8207 13.186 14.9378 13.0346 15.0833 12.9138C15.2289 12.7931 15.3993 12.7059 15.5824 12.6586C15.7655 12.6112 15.9568 12.6049 16.1426 12.64C16.3966 12.6893 16.63 12.8131 16.8132 12.9957C16.9964 13.1784 17.121 13.4114 17.1711 13.6652C17.2217 13.9316 17.1868 14.2071 17.0713 14.4525C16.9559 14.6978 16.7658 14.9003 16.5283 15.0311C16.135 15.259 15.8101 15.5881 15.5872 15.9843C15.3644 16.3804 15.2519 16.8291 15.2614 17.2835V17.7611C15.2614 17.9315 15.3291 18.095 15.4496 18.2156C15.5702 18.3361 15.7337 18.4039 15.9042 18.4039C16.0746 18.4039 16.2381 18.3361 16.3587 18.2156C16.4792 18.095 16.547 17.9315 16.547 17.7611V17.2835C16.5389 17.0598 16.5899 16.8379 16.6948 16.6402C16.7998 16.4425 16.955 16.276 17.1447 16.1573C17.6105 15.9015 17.9855 15.5077 18.2183 15.0301C18.451 14.5525 18.5301 14.0145 18.4446 13.4901C18.3592 12.9657 18.1133 12.4806 17.7409 12.1016C17.3685 11.7226 16.8879 11.4683 16.365 11.3737Z" fill="#5EC075"/>
            <path d="M16.5468 19.6897C16.5468 19.3347 16.259 19.0469 15.904 19.0469C15.549 19.0469 15.2612 19.3347 15.2612 19.6897C15.2612 20.0447 15.549 20.3325 15.904 20.3325C16.259 20.3325 16.5468 20.0447 16.5468 19.6897Z" fill="#5EC075"/>
            <path d="M5 1H27V-1H5V1ZM31 5V27H33V5H31ZM27 31H5V33H27V31ZM1 27V5H-1V27H1ZM5 31C2.79086 31 1 29.2091 1 27H-1C-1 30.3137 1.68629 33 5 33V31ZM31 27C31 29.2091 29.2091 31 27 31V33C30.3137 33 33 30.3137 33 27H31ZM27 1C29.2091 1 31 2.79086 31 5H33C33 1.68629 30.3137 -1 27 -1V1ZM5 -1C1.68629 -1 -1 1.68629 -1 5H1C1 2.79086 2.79086 1 5 1V-1Z" fill="#5EC075"/>
            </svg>
        </div>
    </div>
    <div class="settings-ignore_max">
        <div class="settings-ignore__add">
            <div class="settings-ignore__add-search">
                <svg class="settings-ignore__add-search-img " width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14.8167 13.933L10.5511 9.66739C11.3774 8.64678 11.8749 7.34991 11.8749 5.93744C11.8749 2.66373 9.21113 0 5.93742 0C2.6637 0 0 2.6637 0 5.93741C0 9.21112 2.66373 11.8749 5.93745 11.8749C7.34992 11.8749 8.64679 11.3774 9.66739 10.5511L13.933 14.8167C14.0548 14.9386 14.2148 14.9998 14.3749 14.9998C14.5349 14.9998 14.6949 14.9386 14.8167 14.8167C15.0611 14.5723 15.0611 14.1773 14.8167 13.933ZM5.93745 10.6249C3.35246 10.6249 1.25 8.52239 1.25 5.93741C1.25 3.35243 3.35246 1.24997 5.93745 1.24997C8.52243 1.24997 10.6249 3.35243 10.6249 5.93741C10.6249 8.52239 8.5224 10.6249 5.93745 10.6249Z" fill="#9797BB"/>
                </svg>
                <input type="text" class="settings-ignore__add-search-input" placeholder="Поиск по номеру " v-model="search" @input="searchNumber(search)" v-maska="'7##########'">
            </div>
            <div class="settings-ignore__add-button base-button_enter pointer" @click="openModal(true), channgeTitle('Добавить номер'), emptyData()">
                <div>+</div>
                <div class="settings-ignore__add-button-title ">Добавить номер</div>   
            </div>
        </div>
        <div class="settings-ignore__data">
            <table class="settings-ignore__data-table" :class="{'settings-ignore__data-table_border-bottom':arrNumbers}">
                <tr class="settings-ignore__data-table-tr-title">
                    <th class="settings-ignore__data-table-th  settings-ignore__data-table-text-left settings-ignore-w20">Номер телефона </th>
                    <th class="settings-ignore__data-table-th settings-ignore-w60 settings-ignore__data-table-text-left">Cервисы, из которых не будут приходить сообщения</th>
                    <th class="settings-ignore__data-table-th settings-ignore-w20 settings-ignore__data-table-text-right">Опции</th>
                </tr>
                <tr>
                    <td colspan="3" class="settings-ignore__data-table_padding">
                        <div v-if="NumberNotFound" class="settings-ignore__empty"> 
                            <div class="settings-ignore__empty-text">Номер не добавлен в игнор-лист</div>
                        </div>
                        <div class="settings-ignore__data-table-scroll" v-else-if="searchArrayData&&searchArrayData.length!=0">
                            <table class="settings-ignore__data-table-scroll-row" >
                                <IgnoreRow  @getPhone="getEditPhone" :data="searchArrayData"  :search="searchArrayData" @del="delPhone"></IgnoreRow>
                            </table>
                        </div>
                         
                        <div v-else class="settings-ignore__empty"> 
                            <div class="settings-ignore__empty-text">У вас еще нет подключенных</div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <teleport to="body" v-if="loading">
            <FullScreenLoader ></FullScreenLoader>
    </teleport>
    <ModalIgnoreNumber v-if="isModal" @close="openModal" :title="titleModal" :editData="EditPhone" @update="getAllNumbers"></ModalIgnoreNumber>
</div>
</template>
<script>
    import {ref, computed} from "vue"
    import IgnoreRow from "./IgnoreRow"
    import {useIgnore} from "../../../composition/useIgnore"
    import ModalIgnoreNumber from "../../../components/Modals/ignore/ModalIgnoreNumber"
    import FullScreenLoader from "../../../components/FullScreenLoader"
    export default {
        components: {
            IgnoreRow,
            ModalIgnoreNumber,
            FullScreenLoader
        },
        props:{},
        setup(props, {emit}) {
            const titleModal = ref();
            const isModal = ref(false);
            const { getAllIgnoreNumbers, addIgnoreNumber, getOneNumber, deleteIgnoreNumber } = useIgnore()
            const arrNumbers = ref([]);
            const arrPhone = ref([]);
            const search = ref();
            const keyNumber = ref([]);
            const EditPhone = ref({});
            const searchArrayData = ref();
            const loading = ref(false);
            const getAllNumbers = () => {
                 loading.value = true;
               getAllIgnoreNumbers()
                .then ((r)=>{
                       loading.value = false;
                 if(r.error){
                    return
                }
                arrNumbers.value = r.phones
                for (let key in arrNumbers.value){
                    // arrPhone.value.push(formatedPhone(key))
                    keyNumber.value.push(key)
                }
                searchNumber();
            }) 
            } 
            const emptyData = () =>{
                EditPhone.value = null
            }
            getAllNumbers();
            const getEditPhone = (number) => {
                getOneNumber(number)
                .then((r)=>{
                    EditPhone.value = r
                    channgeTitle('Изменить номер')
                    openModal(true) 
                })
            }
            const delPhone = (phone) => {
                if(phone){
                    loading.value = true;
                    deleteIgnoreNumber(phone)
                    .then((r)=>{
                       getAllNumbers();
                        loading.value = false;
                   })
                }
            }
            const openModal = (bool) => {
               isModal.value = bool; 
            }
            const channgeTitle  = (title) => {
                titleModal.value = title
            }
            const NumberNotFound = ref(false)
            const searchNumber = (number) => {
                if(number){
                searchArrayData.value =  Object.values(arrNumbers.value).filter(item => item.phone.startsWith(number))
                if(searchArrayData.value.length==0){
                    NumberNotFound.value = true;
                }
                else{
                    NumberNotFound.value = false;
                }
                }
                else{
                searchArrayData.value  = arrNumbers.value
                }  
            }
            
            return {
                openModal,
                isModal,
                titleModal,
                channgeTitle,
                arrNumbers,
                arrPhone,
                searchNumber,
                search,
                keyNumber,
                searchArrayData,
                EditPhone,
                getEditPhone,
                getAllNumbers,
                delPhone,
                loading,
                emptyData,
                NumberNotFound
            }
        },
    }
</script>
<style lang="scss" src="./ignore.scss"></style>